# 第1章 计算机系统概览

## 1.1 计算机系统的组成

计算机系统：包括硬件子系统和软件子系统

硬件：借助点、磁、光、机械等原理构成的各种物理部件的有机组合，是系统工作的实体

> 如：CPU，主存储器，IO控制系统，外围设备

软件：各种程序和文件，用于指挥计算机系统按指定的要求进行协同工作

> 包括系统软件、支撑软件和应用软件
>
> 关键的系统软件是：操作系统与语言处理程序

## 1.2 计算机硬件系统

包括 

中央处理器：运算单元、控制单元

主存储器

外围设备：输入、输出设备，存储设备，网络通信设备

总线

### 1.2.1 冯·诺依曼计算机模型

存储程序计算机在体系结构上的主要特点

1.以运算单元为中心，控制流由指令流产生

2.采用存储程序原理，面向主存组织数据流

3.主存是按地址访问、线性编址的空间

4.指定由操作码和地址码组成

5.数据以二进制进行编码

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309152030795.png" alt="image-20200309152030795" style="zoom: 33%;" />

### 1.2.2 总线及其组成

总线（Bus）是计算机各种功能部件之间传送信息的公共通信干线，它是CPU、内存、输入输出设备传递信息的公用通道。

计算机的各个部件通过总线相连接，外围设备通过相应的接口电路再与总线相连接，从而形成了计算机硬件系统。

按照所传输的信息种类，总线包括一组控制线、一组数据线和一组地址线。

### 1.2.3 总线的类型

1.内部总线：用于CPU芯片内部连接各元件

2.系统总线：用于连接CPU、存储器和各种IO模块等主要部件

3.通信总线：用于计算机系统之间进行通信

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309152438627.png" alt="image-20200309152438627" style="zoom:33%;" />

### 1.2.4 中央处理器（CPU）

中央处理器是计算机的运算核心和控制单元，主要功能包括：

> 运算逻辑部件：一个或多个运算器
>
> 寄存器部件：包括通用寄存器、控制与状态寄存器，高速缓冲存储器（cache）
>
> 控制部件：
>
> ​	实现各部件之间联系的数据、控制以及状态的内部总线
>
> ​	负责对指令译码、发出为完成每条指令所要执行操作的控制信号、实现数据传输等功能的部件

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309152834054.png" alt="image-20200309152834054" style="zoom:33%;" />

### 1.2.5 存储器的组织层次

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309152939717.png" alt="image-20200309152939717" style="zoom:33%;" />

L3之前是Cache，断点没了。

### 1.2.5 外围设备及其控制

设备类型：输入输出设备、存储设备、机机通信设备。

设备控制方式：

1.轮询方式：CPU忙式控制，CPU执行内存数据交换

2.中断方式：CPU启动外设，外设中断CPU，CPU执行内存数据交换

3.DMA方式：CPU启动DMA，DMA执行输入输出与内存数据交换，DMA中断CPU

## 1.3 计算机软件系统

### 1.3.1 系统软件

操作系统：实施对各种软硬件资源的管理控制

实用程序：为方便用户所设，如文本编辑器等

语言处理程序：把用汇编、高级语言编写的程序翻译成可执行的机器语言程序

数据库管理系统

### 1.3.2 支撑软件

有接口软件、工具软件、环境数据库，支持用户使用计算机的环境，提供开发工具

也可以认为是系统软件的一部分

### 1.3.3 应用软件

是用户按其需要自行编写的专用程序

### 1.3.4 程序员的计算机系统视图

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309153619707.png" alt="image-20200309153619707" style="zoom:33%;" />

### 1.3.5 软件开发的不同层次

计算机硬件系统：机器语言

操作系统的资源管理：机器语言+广义指令（扩充了硬件资源管理）

OS的文件系统：机器语言+系统调用（扩充了信息资源管理）

数据库系统：数据库语言（扩充了功能更强的信息资源管理）

语言处理程序：面向问题的语言

### 1.3.6 高级语言的执行顺序

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200309153827312.png" alt="image-20200309153827312" style="zoom:33%;" />

## 1.4 操作系统的组成

### 1.4.1 组成

1.进程调度子系统

2.进程通信子系统

3.内存管理子系统

4.设备管理子系统

5.文件管理子系统

6.网络通信子系统

7.作业控制子系统

### 1.4.2 类型

1.从操作控制方式看

> 多道批处理操作系统，采用脱机控制方式
>
> 分时操作系统，采用交互控制方式
>
> 实时操作系统

2.从应用领域看

> 服务器操作系统、并行操作系统
>
> 网络操作系统、分布式操作系统
>
> 个人机操作系统、手机操作系统
>
> 嵌入式操作系统、传感器操作系统

## 1.5 资源管理角度

### 1.5.1 管理计算机系统的软硬件资源

处理器资源：哪个程序占有处理器运行？

内存资源：程序/数据在内存中如何分布？

设备管理：如何分配、去配和使用设备？

信息资源管理：如何访问文件信息？

信号量资源：如何管理进程之间的通信？

### 1.5.2 屏蔽资源使用的底层细节

驱动程序：最底层的、直接控制和监视各类硬件（或文件）资源的部分

职责是隐藏底层硬件的具体细节，并向其他部分提供一个抽象的、通用的接口

### 1.5.3 资源的共享与分配方式

共享方式：

​	独占使用方式

​	并发使用方式

资源配策略：

​	静态分配方式

​	动态分配方式：谁用谁分配

​	资源抢占方式：谁优先级高谁用

## 1.6 控制程序执行角度

### 1.6.1 多道程序同时计算

CPU速度与IO速度不匹配的矛盾非常突出

只有让多道程序同时进入内存争抢CPU执行权，才可以使得CPU和外围设备充分并行，从而提高计算机系统的使用效率。

### 1.6.2 多道程序设计及优点

多道程序设计指让多个程序同时进入计算机的主存储器进行计算

特点：

1.CPU与外部设备充分并行

2.外部设备之间充分并行

3.发挥CPU的使用效率

4.提高单位时间的算题量 

### 1.6.3 多道程序系统的实现

为进入内存执行的程序建立管理实体：**进程**

OS应该能够管理与控制进程程序的执行

OS应该能够协调管理各类资源在进程间的使用，包括：

1.处理器的管理和调度

2.主存储器的管理和调度

3.其他资源的管理和调度

### 1.6.7 多道程序系统的实现要点

1.如何使用资源：调用OS提供的服务例程

2.如何复用CPU：调度程序（在CPU空闲时让其他程序运行）

3.如何使CPU与IO设备充分并行：设备控制器与通道（专用的IO处理器）

4.如何让正在运行的程序让出CPU：中断（中断正在执行的程序，引入OS处理）

## 1.7 操作系统控制计算机的角度

### 1.7.1 计算机系统操作方式

OS规定了合理操作计算机的工作流程

OS的操作接口——系统程序

OS提供给用户的功能级接口，为用户提供的解决操作计算机和计算共性问题的所有服务的集合

OS的两类作业级接口：

​	脱机作业控制方式：作业控制语言

​	联机作业控制方式：操作控制命令

### 1.7.2 脱机作业控制方式

OS：提供作业说明语言

用户：编写作业说明书，确定作业加工程序步骤，并与程序数据一并提交

操作员：通过控制台输入作业

OS：通过作业控制程序自动控制作业的执行

例如：批处理OS的作业控制方式，UNIX的shell程序，DOS的bat文件

### 1.7.3 连接作业控制方式

计算机：提供中断（键盘/显示器）

用户：登陆系统

OS：提供命令解释程序

用户：联机输入命令，直接控制作业步骤的执行

例如：分时OS的交互控制方式

### 1.7.4 命令解释程序

接收和执行一条用户提出的对作业的加工处理命令

当额新的批作业被启动，或新的交互型用户登陆进系统时，系统就自动地执行命令解释程序，负责读入控制卡或命令行，作出相应解释，并予以执行。

会话语言：可编程的命令解释程序

图形化的命令控制方式

多通道交互的命令控制方式

### 1.7.5 命令解释程序的处理过程

OS启动命令解释程序，输出命令提示符，等待键盘中断/鼠标点击/多通道识别

每当用户输入一条命令（暂存在命令缓冲区）并按回车换行时，申请中断

CPU响应后，将控制权交给命令解释程序，接着读入命令缓冲区的内容，分析命令、接收参数，执行处理代码

前台命令执行结束后，再次输出命令提示符，等待下一条命令

后台命令处理启动后，即可接收下条命令

## 1.8 人机交互的角度

## 1.9 程序接口的角度



## 1.10 系统结构的角度

OS构件：内核、进程、线程、管程等

设计概念：模块化、层次化、虚拟化

内核设计是OS设计中最为复杂的部分

# 第2章 处理器管理

## 2.1 处理器与寄存器

### 2.1.1 处理器

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200310150631079.png" alt="image-20200310150631079" style="zoom:33%;" />

### 2.2.2 寄存器

1.用户程序可见寄存器

可以使程序员减少访问主存储器的次数，提高指令执行的效率

所有程序都可以使用，包括应用程序和系统程序

数据寄存器：又称通用寄存器

地址寄存器：索引、栈地址、段地址等寄存器

2.控制与状态寄存器

用于控制处理器的操作；主要被具有特权的操作系统程序使用，以控制程序的执行

程序计数器PC：存储将取指令的地址

指令寄存器IR：存储最近使用的指令

条件码CC：CPU为指令操作结果设置的位，标志正/负/零/溢出等结果

标志位：中断位、中断允许位、中断屏蔽位、处理器模式位、内存保护位、等。

3.程序状态字PSW

既是操作系统的概念，指记录当前程序运行的动态信息，通常包含：

程序计数器，指令寄存器，条件码

中断字，中断允许/禁止，中断屏蔽，处理器模式，内存保护，调试控制

也是计算机系统的寄存器：

通常设置一组控制与状态寄存器

也可以专设一个PSW寄存器

## 2.2 指令与处理器模式

### 2.2.1 机器指令

机器指令：计算机系统执行的基本命令，是中央处理器执行的基本单位。

指令由一个或多个字节组成，包括操作码字段、一个或多个操作数地址字段、以及一些表征机器状态的状态字以及特征码

指令完成各种算术逻辑运算、数据传输、控制流跳转征码

### 2.2.2 指令执行过程：

CPU根据PC取指令，放入IR，并对指令译码，然后发出各种控制命令，执行微操作序列，从而完成一条指令的执行。

一种指令的执行步骤如下：

1.取指：根据PC从存储器或高速缓冲存储器中去指令到IR

2.解码：解释IR中的指令来决定其执行行为

3.执行：连接到CPU部件，执行运算，产生结果并协会，同时在CC里设置运算结论标志；跳转指令操作PC，其他指令递增PC值。

### 2.2.3 指令执行周期与指令流水线

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200310151847534.png" alt="image-20200310151847534" style="zoom:33%;" />

每行代表一个指令执行

### 2.2.4 特区指令与非特权指令

用户程序并非能够使用全部的机器指令，那些与计算机核心资源相关的特殊指令会被保护

如：启动IO指令、置PC指令等。

核心资源相关的指令只能被操作系统程序使用

特权指令：只能被操作系统内核使用的指令

非特权指令：所有程序都能使用的指令

### 2.2.5 处理器模式

通过设置处理器模式实现特权指令管理

一般设置0、1、2、3等四种运行模式，建议分别对应：0操作系统内核、1系统调用、2共享库程序、3用户程序等保护几波额

0模式可以执行全部指令；3模式只能执行非特权指令；其他每种运行模式可以规定执行的指令子集

一般来说，现代OS只使用0和3两种模式，对应于内核模式和用户模式

### 2.2.6 模式的切换

包括“用户——》内核”和“内核——》用户”的转换

中断、异常或系统异常等时间导致用户程序向OS内核切换，触发用户——》内核模式

程序运行时发生相应并中断

程序运行时发生异常

程序请求操作系统服务

OS内核处理完成后，调用中断返回指令，触发内核——》用户模式

## 2.3 中断

### 2.3.1 概念

程序执行过程中，遇到急需处理的时间时，暂时中止CPU上现行程序的运行，转去执行相应的事件处理程序，待处理完成后再返回原程序被中断处或调度其他程序执行的过程

OS是“中断驱动”的；换言之，中断是激活操作系统的唯一方式。

中断有广义和狭义之分，上述是广义中断

狭义的中断是指来源于处理器之外的中断事件，即与当前运行指令无关的中断事件，如IO中断、时间中断、外部信号中断。

异常指当前运行指令引起的中断事件，如地址异常、算数异常、处理器硬件故障等。

系统异常指执行陷入指令而出发系统调用引起的中断事件，如请求设备、请求IO、创建进程等。

### 2.3.2 中断源

1.处理器硬件故障中断事件

由处理器、内存储器、总线等硬件故障引起

处理原则为：保护现场，停止设备，停止CPU，向操作员报告，等待人工干预

2.程序性中断事件

处理器执行机器指令引起

如：除数为0、操作数溢出等算输一场：可简单处理，报告用户；也可以由用户编写中断续元程序处理

非法指令、用户态使用特权指令、地址越界、非法存取等指令异常：终止进程

终止进程指令：终止进程

虚拟地址异常：调整内存后重新执行指令

3.系统异常

处理器执行陷入指令请求OS服务引起；在操作系统中，它一般又被称作系统调用

请求分配外设、请求IO等

处理流程是：陷入OS，保护现场，根据功能号查入口库地址，跳转具体处理程序

4.IO中断事件

来源于外围设备报告IO状态的中断事件

IO完成：调整进程状态，释放等待进程

IO出错、异常：等待人工干预

5.外部中断事件

由外围设备发出的信号引起的中断事件

始终中断、间隔时钟中断：计时与时间片处理

设备报到与结束中断：调整设备表

键盘、鼠标信号中断：根据信号作出相应反应

关机、重启中断：写回文件，停止设备与CPU

### 中断系统

计算机系统中相应和处理中断的系统，包括硬件子系统和软件子系统两部分

中断响应由硬件子系统完成

中断处理由软件子系统完成

<img src="C:\Users\45928\AppData\Roaming\Typora\typora-user-images\image-20200310154214589.png" alt="image-20200310154214589" style="zoom:33%;" />

中断装置：计算机系统中发现并响应中断/异常的硬件装置

由于中断源的多样性，硬件实现的中断装置有多重，分别处理不同类型的中断

这些中断装置因计算机而异，通常有：

处理器外的中断：由中断控制器发现和响应

处理器内的异常：由指令的控制逻辑和实现线路发现和响应，相应机制成为陷阱

请求OS服务的系统异常：处理器执行陷入指令时直接出发，相应机制成为系统陷阱

中断控制器：CPU中的一个控制部件，包括中断控制逻辑线路和中断寄存器

外部设备向其发出中断请求IRQ